<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet author="Chethan, Shruthi" id="Reports-022420151643" runOnChange="true">
        <comment>Creating view concept</comment>
        <createView viewName="concept_view" replaceIfExists="true">
            SELECT concept.concept_id, concept_full_name.name AS concept_full_name, concept_short_name.name
            AS concept_short_name, concept_class.name AS concept_class_name,concept_datatype.name
            AS concept_datatype_name,concept.retired,concept_description.description,concept.date_created
            AS date_created FROM concept LEFT OUTER JOIN concept_name AS concept_full_name
            ON concept_full_name.concept_id = concept.concept_id AND concept_full_name.concept_name_type = 'FULLY_SPECIFIED'
            AND concept_full_name.locale = 'en' AND concept_full_name.voided = 0
            LEFT OUTER JOIN concept_name AS concept_short_name ON concept_short_name.concept_id = concept.concept_id
            AND concept_short_name.concept_name_type = 'SHORT'AND concept_short_name.locale = 'en' AND concept_short_name.voided = 0
            LEFT OUTER JOIN concept_class ON concept_class.concept_class_id = concept.class_id
            LEFT OUTER JOIN concept_datatype ON concept_datatype.concept_datatype_id = concept.datatype_id
            LEFT OUTER JOIN concept_description ON concept_description.concept_id = concept.concept_id;
        </createView>
    </changeSet>
    <changeSet author="Chethan, Shruthi" id="Reports-022520150918" runOnChange="true">
        <comment>Creating view coded obs</comment>
        <createView viewName="coded_obs_view" replaceIfExists="true">
            SELECT obs.obs_id, obs.concept_id, obs.person_id, obs.value_coded, obs.obs_group_id, obs.obs_datetime,
            obs.encounter_id, obs.creator, reference_concept.concept_full_name AS concept_full_name,
            value_concept.concept_full_name AS value_concept_full_name, obs.voided FROM obs JOIN concept_view
            AS reference_concept ON reference_concept.concept_id = obs.concept_id
            AND (reference_concept.concept_datatype_name = 'Coded' or reference_concept.concept_datatype_name = 'Boolean')
            LEFT OUTER JOIN concept_view AS value_concept ON value_concept.concept_id = obs.value_coded;
        </createView>
    </changeSet>
    <changeSet author="Chethan, Shruthi" id="Reports-022520150925" runOnChange="true">
        <comment>Creating view valid coded obs</comment>
        <createView viewName="valid_coded_obs_view" replaceIfExists="true">
            SELECT * FROM coded_obs_view WHERE coded_obs_view.voided = 0;
        </createView>
    </changeSet>
    <changeSet id="Reports-022620151602" author="Chethan, Sravanthi">
        <preConditions onFail="MARK_RAN">
            <not><tableExists tableName="reporting_age_group"/></not>
        </preConditions>
        <comment>Creating table for reporting age group</comment>
        <createTable tableName="reporting_age_group">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="reporting_age_group_pk" nullable="false" />
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="report_group_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="min_years" type="int" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="min_days" type="int" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="max_years" type="int" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="max_days" type="int" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="sort_order" type="int" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
</databaseChangeLog>